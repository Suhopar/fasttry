<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä –ø–ª–∏—Ç–æ–∫</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #e0e5ec;
      --shadow-d: #a3b1c6;
      --shadow-l: #ffffff;
      --accent: #6d9dc5;
      --accent-light: #8bb8db;
      --danger: #e07a7a;
      --text: #4a5568;
      --text-muted: #718096;
    }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
    }

    /* Neumorphic base */
    .neu {
      background: var(--bg);
      border-radius: 16px;
      box-shadow: 
        6px 6px 12px var(--shadow-d),
        -6px -6px 12px var(--shadow-l);
    }
    .neu-inset {
      background: var(--bg);
      border-radius: 12px;
      box-shadow: 
        inset 3px 3px 6px var(--shadow-d),
        inset -3px -3px 6px var(--shadow-l);
    }
    .neu-flat {
      background: var(--bg);
      border-radius: 10px;
      box-shadow: 
        3px 3px 6px var(--shadow-d),
        -3px -3px 6px var(--shadow-l);
    }
    .neu-pressed {
      background: var(--bg);
      border-radius: 10px;
      box-shadow: 
        inset 2px 2px 5px var(--shadow-d),
        inset -2px -2px 5px var(--shadow-l);
    }

    /* Sidebars */
    .sidebar {
      width: 180px;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg);
    }
    .sidebar-left { 
      box-shadow: 6px 0 15px rgba(0,0,0,0.05);
    }
    .sidebar-right { 
      box-shadow: -6px 0 15px rgba(0,0,0,0.05);
    }

    .panel {
      padding: 12px;
      border-radius: 16px;
      background: var(--bg);
      overflow: hidden;
      box-shadow: 
        inset 4px 4px 8px var(--shadow-d),
        inset -4px -4px 8px var(--shadow-l);
    }
    .panel-title {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Main area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Board wrapper - no border, just water */
    .board-wrap {
      position: relative;
      padding: 10px;
      background: transparent;
    }

    /* Wave background - water effect */
    .wave-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 16px;
      overflow: hidden;
      pointer-events: none;
      background: linear-gradient(180deg, 
        rgba(93, 173, 226, 0.2) 0%,
        rgba(52, 152, 219, 0.3) 50%,
        rgba(41, 128, 185, 0.25) 100%);
    }
    
    /* Water layers */
    .wave-bg::before,
    .wave-bg::after {
      content: '';
      position: absolute;
      left: -50%;
      width: 200%;
      height: 100%;
      background-repeat: no-repeat;
    }
    
    .wave-bg::before {
      top: 0;
      background: linear-gradient(180deg,
        rgba(52, 152, 219, 0.4) 0%,
        rgba(41, 128, 185, 0.2) 30%,
        transparent 60%);
      animation: wave-flow-1 15s ease-in-out infinite;
    }
    
    .wave-bg::after {
      top: 0;
      background: linear-gradient(180deg,
        rgba(93, 173, 226, 0.3) 0%,
        rgba(52, 152, 219, 0.15) 40%,
        transparent 70%);
      animation: wave-flow-2 20s ease-in-out infinite;
    }
    
    @keyframes wave-flow-1 {
      0% { 
        transform: translateY(-100%) translateX(0%);
      }
      50% {
        transform: translateY(50%) translateX(10%);
      }
      100% { 
        transform: translateY(100%) translateX(0%);
      }
    }
    
    @keyframes wave-flow-2 {
      0% { 
        transform: translateY(-80%) translateX(5%);
      }
      50% {
        transform: translateY(30%) translateX(-5%);
      }
      100% { 
        transform: translateY(120%) translateX(5%);
      }
    }

    /* Extra shimmer layer */
    .wave-shimmer {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 16px;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }
    
    .wave-shimmer::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,0.2) 25%,
        rgba(255,255,255,0.3) 50%,
        rgba(255,255,255,0.2) 75%,
        transparent 100%);
      animation: shimmer 15s linear infinite;
    }
    
    .wave-shimmer::after {
      content: '';
      position: absolute;
      top: -100%;
      left: 0;
      width: 100%;
      height: 200%;
      background: linear-gradient(180deg,
        transparent 0%,
        rgba(100, 180, 255, 0.15) 40%,
        rgba(50, 150, 220, 0.25) 50%,
        rgba(100, 180, 255, 0.15) 60%,
        transparent 100%);
      animation: wave-vertical 12s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }
    
    @keyframes wave-vertical {
      0%, 100% { transform: translateY(0%); }
      50% { transform: translateY(50%); }
    }

    /* Ripple circles */
    .wave-ripples {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 16px;
      overflow: hidden;
      pointer-events: none;
      z-index: 1;
    }
    
    .wave-ripples::before,
    .wave-ripples::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      border: 3px solid rgba(52, 152, 219, 0.4);
      animation: ripple 15s ease-out infinite;
    }
    
    .wave-ripples::before {
      width: 40px;
      height: 40px;
      top: 25%;
      left: 20%;
      animation-delay: 0s;
    }
    
    .wave-ripples::after {
      width: 30px;
      height: 30px;
      bottom: 35%;
      right: 15%;
      animation-delay: 7.5s;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0.3);
        opacity: 1;
      }
      100% {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* Flowing wave band */
    .wave-flow {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 16px;
      overflow: hidden;
      pointer-events: none;
      z-index: 1;
    }
    
    .wave-flow::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -20%;
      width: 140%;
      height: 80%;
      background: linear-gradient(180deg,
        transparent 0%,
        rgba(100, 200, 255, 0.2) 45%,
        rgba(50, 150, 230, 0.35) 50%,
        rgba(100, 200, 255, 0.2) 55%,
        transparent 100%);
      border-radius: 50%;
      animation: flow-down 10s ease-in-out infinite;
    }
    
    .wave-flow::after {
      content: '';
      position: absolute;
      top: -30%;
      left: -10%;
      width: 120%;
      height: 60%;
      background: linear-gradient(180deg,
        transparent 0%,
        rgba(150, 220, 255, 0.15) 45%,
        rgba(80, 180, 240, 0.25) 50%,
        rgba(150, 220, 255, 0.15) 55%,
        transparent 100%);
      border-radius: 50%;
      animation: flow-down 10s ease-in-out infinite;
      animation-delay: 5s;
    }
    
    @keyframes flow-down {
      0% {
        transform: translateY(0%) scaleX(1);
        opacity: 0.8;
      }
      50% {
        transform: translateY(100%) scaleX(1.1);
        opacity: 1;
      }
      100% {
        transform: translateY(200%) scaleX(1);
        opacity: 0.8;
      }
    }

    .board {
      position: relative;
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(15, 1fr);
      gap: 4px;
      width: min(calc(100vw - 400px), 280px);
      aspect-ratio: 9 / 15;
      z-index: 2;
    }

    /* Tiles - Neumorphic */
    .tile {
      border-radius: 8px;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      cursor: pointer;
      position: relative;
      box-shadow: 
        3px 3px 6px var(--shadow-d),
        -3px -3px 6px var(--shadow-l);
      transition: all 0.15s ease;
      border: 2px solid transparent;
    }
    .tile:hover {
      box-shadow: 
        4px 4px 8px var(--shadow-d),
        -4px -4px 8px var(--shadow-l);
    }
    .tile:active { 
      box-shadow: 
        inset 2px 2px 4px var(--shadow-d),
        inset -2px -2px 4px var(--shadow-l);
    }
    .tile.drag-over { 
      transform: scale(1.08); 
      z-index: 5;
      box-shadow: 
        5px 5px 10px var(--shadow-d),
        -5px -5px 10px var(--shadow-l),
        0 0 0 3px var(--accent);
    }
    .tile.dragging { opacity: 0.4; }
    .tile.path-point { 
      box-shadow: 
        3px 3px 6px var(--shadow-d),
        -3px -3px 6px var(--shadow-l),
        0 0 0 3px var(--danger);
    }

    /* Border colors - subtle */
    .tile[data-color="none"] { border-color: transparent; }
    .tile[data-color="blue"] { border-color: rgba(93, 173, 226, 0.5); }
    .tile[data-color="cyan"] { border-color: rgba(72, 201, 176, 0.5); }
    .tile[data-color="green"] { border-color: rgba(88, 214, 141, 0.5); }
    .tile[data-color="lime"] { border-color: rgba(174, 213, 129, 0.5); }
    .tile[data-color="yellow"] { border-color: rgba(247, 220, 111, 0.6); }
    .tile[data-color="orange"] { border-color: rgba(245, 176, 65, 0.5); }
    .tile[data-color="red"] { border-color: rgba(236, 112, 99, 0.5); }
    .tile[data-color="pink"] { border-color: rgba(241, 148, 138, 0.5); }
    .tile[data-color="purple"] { border-color: rgba(187, 143, 206, 0.5); }
    .tile[data-color="brown"] { border-color: rgba(161, 136, 127, 0.5); }
    .tile[data-color="gray"] { border-color: rgba(130, 130, 130, 0.4); }

    /* Kings - elevated */
    .tile.king {
      grid-column: span 2;
      grid-row: span 2;
      font-size: 2rem;
      cursor: default;
      z-index: 10;
      border-radius: 12px;
      box-shadow: 
        6px 6px 12px var(--shadow-d),
        -6px -6px 12px var(--shadow-l);
    }
    .tile.duck-king { 
      grid-column: 8/10; 
      grid-row: 1/3; 
      border-color: rgba(247, 220, 111, 0.6);
    }
    .tile.frog-king { 
      grid-column: 1/3; 
      grid-row: 14/16; 
      border-color: rgba(174, 213, 129, 0.6);
    }

    /* Color grid */
    .color-grid { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 6px;
    }
    .color-btn {
      aspect-ratio: 1;
      width: 100%;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 
        3px 3px 6px var(--shadow-d),
        -3px -3px 6px var(--shadow-l);
    }
    .color-btn:hover { transform: scale(1.05); }
    .color-btn.selected { 
      box-shadow: 
        inset 2px 2px 4px var(--shadow-d),
        inset -2px -2px 4px var(--shadow-l);
    }
    .color-btn[data-c="none"] { background: var(--bg); }
    .color-btn[data-c="blue"] { background: linear-gradient(145deg, #6db3e8, #5296c4); }
    .color-btn[data-c="cyan"] { background: linear-gradient(145deg, #52d4bc, #3eb5a0); }
    .color-btn[data-c="green"] { background: linear-gradient(145deg, #64e09b, #4cc282); }
    .color-btn[data-c="lime"] { background: linear-gradient(145deg, #bedf8d, #9ec076); }
    .color-btn[data-c="yellow"] { background: linear-gradient(145deg, #ffe27a, #dfc465); }
    .color-btn[data-c="orange"] { background: linear-gradient(145deg, #ffc14d, #dfa33a); }
    .color-btn[data-c="red"] { background: linear-gradient(145deg, #f28076, #d46259); }
    .color-btn[data-c="pink"] { background: linear-gradient(145deg, #f7a8a0, #d88b83); }
    .color-btn[data-c="purple"] { background: linear-gradient(145deg, #caa0de, #ab82bf); }
    .color-btn[data-c="brown"] { background: linear-gradient(145deg, #b39890, #947b74); }
    .color-btn[data-c="gray"] { background: linear-gradient(145deg, #b8b8b8, #9a9a9a); }

    /* Emoji buttons */
    .emoji-row { 
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px; 
    }
    .emoji-btn {
      aspect-ratio: 1;
      width: 100%;
      border: none; 
      border-radius: 8px;
      background: var(--bg);
      font-size: 1.1rem;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      box-shadow: 
        2px 2px 4px var(--shadow-d),
        -2px -2px 4px var(--shadow-l);
    }
    .emoji-btn:hover { 
      transform: scale(1.05);
      box-shadow: 
        3px 3px 6px var(--shadow-d),
        -3px -3px 6px var(--shadow-l);
    }
    .emoji-btn:active {
      box-shadow: 
        inset 2px 2px 4px var(--shadow-d),
        inset -2px -2px 4px var(--shadow-l);
    }

    /* Category buttons */
    .cat-row { 
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 8px; 
    }
    .cat-btn {
      aspect-ratio: 1;
      width: 100%;
      border: none; 
      border-radius: 6px;
      background: var(--bg);
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      box-shadow: 
        2px 2px 4px var(--shadow-d),
        -2px -2px 4px var(--shadow-l);
    }
    .cat-btn:hover { transform: scale(1.03); }
    .cat-btn.active { 
      box-shadow: 
        inset 2px 2px 4px var(--shadow-d),
        inset -2px -2px 4px var(--shadow-l);
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      max-height: 120px;
      overflow-y: auto;
      padding: 2px;
    }
    
    .emoji-grid .emoji-btn {
      font-size: 1rem;
    }

    /* Animation panel */
    .anim-section { margin-bottom: 12px; }
    .anim-label { 
      font-size: 0.7rem; 
      color: var(--text-muted); 
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 12px;
      background: var(--bg);
      box-shadow: 
        inset 2px 2px 4px var(--shadow-d),
        inset -2px -2px 4px var(--shadow-l);
    }
    .speed-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 8px;
      border-radius: 4px;
      background: var(--bg);
      box-shadow: 
        inset 1px 1px 3px var(--shadow-d),
        inset -1px -1px 3px var(--shadow-l);
    }
    .speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px; 
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--accent-light), var(--accent));
      cursor: pointer;
      box-shadow: 
        2px 2px 4px var(--shadow-d),
        -1px -1px 3px var(--shadow-l);
    }
    .speed-val { 
      font-size: 0.85rem; 
      font-weight: 700; 
      min-width: 28px;
      color: var(--accent);
    }

    .path-list {
      max-height: 140px;
      overflow-y: auto;
      padding: 4px;
    }
    .path-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      margin-bottom: 6px;
      border-radius: 12px;
      background: var(--bg);
      font-size: 0.8rem;
      box-shadow: 
        3px 3px 6px var(--shadow-d),
        -3px -3px 6px var(--shadow-l);
    }
    .path-emoji { font-size: 1.2rem; }
    .path-info { 
      flex: 1; 
      color: var(--text-muted);
      font-weight: 500;
    }
    .path-del {
      width: 24px; 
      height: 24px;
      border: none; 
      border-radius: 8px;
      background: var(--bg);
      color: var(--danger);
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 
        2px 2px 4px var(--shadow-d),
        -2px -2px 4px var(--shadow-l);
    }
    .path-del:hover {
      background: var(--danger);
      color: white;
    }

    /* Buttons */
    .btn {
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg);
      color: var(--text);
      width: 100%;
      margin-top: 6px;
      transition: all 0.15s ease;
      box-shadow: 
        3px 3px 6px var(--shadow-d),
        -3px -3px 6px var(--shadow-l);
    }
    .btn:hover {
      box-shadow: 
        5px 5px 10px var(--shadow-d),
        -5px -5px 10px var(--shadow-l);
    }
    .btn:active { 
      box-shadow: 
        inset 3px 3px 6px var(--shadow-d),
        inset -3px -3px 6px var(--shadow-l);
    }
    .btn.active { 
      background: linear-gradient(145deg, var(--accent-light), var(--accent));
      color: white;
      box-shadow: 
        inset 2px 2px 4px rgba(0,0,0,0.1),
        inset -2px -2px 4px rgba(255,255,255,0.1);
    }
    .btn.recording { 
      background: linear-gradient(145deg, #ef8f8f, var(--danger));
      color: white;
    }

    .no-paths {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
      padding: 15px 10px;
      font-style: italic;
    }

    /* Recording indicator */
    .board-wrap.recording .wave-bg {
      animation: rec-pulse 1.5s ease-in-out infinite;
    }
    @keyframes rec-pulse {
      0%, 100% { 
        box-shadow: inset 0 0 20px rgba(224, 122, 122, 0.3);
      }
      50% { 
        box-shadow: inset 0 0 40px rgba(224, 122, 122, 0.5);
      }
    }

    @media (max-width: 750px) {
      body { flex-direction: column; }
      .sidebar { 
        width: 100%; 
        max-height: 38vh; 
        flex-direction: row; 
        flex-wrap: wrap;
        padding: 10px;
        gap: 10px;
      }
      .sidebar .panel { flex: 1; min-width: 150px; }
      .sidebar-left { order: 2; }
      .sidebar-right { order: 3; }
      .main { order: 1; padding: 15px; }
      .board { width: min(calc(100vw - 30px), 260px); }
    }
  </style>
</head>
<body>

<!-- Left sidebar - Animation -->
<div class="sidebar sidebar-left">
  <div class="panel">
    <div class="panel-title">üé¨ –ê–Ω—ñ–º–∞—Ü—ñ—ó</div>
    
    <div class="anim-section">
      <div class="anim-label">–®–≤–∏–¥–∫—ñ—Å—Ç—å</div>
      <div class="speed-control">
        <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="5" step="0.5" value="1">
        <span class="speed-val" id="speedVal">1√ó</span>
      </div>
    </div>

    <div class="anim-section">
      <div class="anim-label">–ú–∞—Ä—à—Ä—É—Ç–∏</div>
      <div class="path-list" id="pathList"></div>
    </div>

    <button class="btn" id="recordBtn">üî¥ –ó–∞–ø–∏—Å–∞—Ç–∏</button>
    <button class="btn" id="playBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
    <button class="btn" id="clearPathsBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
  </div>

  <div class="panel">
    <div class="panel-title">üíæ –§–∞–π–ª</div>
    <button class="btn" id="saveBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button class="btn" id="loadBtn">üìÇ –í—ñ–¥–∫—Ä–∏—Ç–∏</button>
    <button class="btn" id="resetBtn">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
  </div>
</div>

<!-- Main board -->
<div class="main">
  <div class="board-wrap" id="boardWrap">
    <div class="wave-bg"></div>
    <div class="wave-shimmer"></div>
    <div class="wave-ripples"></div>
    <div class="wave-flow"></div>
    <div class="board" id="board"></div>
  </div>
</div>

<!-- Right sidebar - Colors & Emoji -->
<div class="sidebar sidebar-right">
  <div class="panel">
    <div class="panel-title">üé® –ì—Ä–∞–Ω—å</div>
    <div class="color-grid" id="colorGrid"></div>
  </div>

  <div class="panel">
    <div class="panel-title">‚≠ê –®–≤–∏–¥–∫—ñ</div>
    <div class="emoji-row" id="quickEmoji"></div>
  </div>

  <div class="panel">
    <div class="panel-title">üòÄ –ï–º–æ–¥–∑—ñ</div>
    <div class="cat-row" id="catRow"></div>
    <div class="emoji-grid" id="emojiGrid"></div>
  </div>
</div>

<script>
const COLS = 9, ROWS = 15;
const COLORS = ['none','blue','cyan','green','lime','yellow','orange','red','pink','purple','brown','gray'];
const EMOJIS = {
  'üòÄ': 'üòÄüòÉüòÑüòÅüòÜüòÖü§£üòÇüôÇüòäüòáü•∞üòçü§©üòòüòãüòéü§ìü•≥üòèüò¢üò≠üò§üò†üòàüëøüíÄüëªüëΩü§ñ'.split(''),
  'üê±': 'üê∂üê±üê≠üêπüê∞ü¶äüêªüêºüê®üêØü¶ÅüêÆüê∑üê∏üêµüêîüêßüê¶üê§ü¶Üü¶Öü¶âüê∫ü¶Ñüêùü¶ãüêåüêûüê¢üêçüêôü¶ëü¶Äüê¨üê≥ü¶à'.split(''),
  'üçé': 'üçéüçêüçäüçãüçåüçâüçáüçìüçíüçëü•≠üççü••ü•ùüçÖü•ëü•¶ü•íüåΩü•ïü•îüçûüßÄü•öüç≥ü•ìüçóüçîüçüüçïüåÆüçúüç£üç©üç™üéÇüç´'.split(''),
  '‚öΩ': '‚öΩüèÄüèà‚öæüéæüèêüèâüé±üèìüè∏ü•äü•ãüèÜü•áü•àü•âüéÆüé≤üéØüé≥üé™üé®üé¨üé§üéßüéπü•Åüé∑üé∏üéª'.split(''),
  'üöó': 'üöóüöïüöôüöåüèéüöìüöëüöíüöêüööüöõüöúüèçüõµüö≤üõ¥üöÅüõ∏üöÄ‚úàüö¢‚õµüöÇüöÉüöÑüöÖüöá'.split(''),
  'üíé': 'üíéüíçüëëüí∞üíµüí≥üèÜüéÅüéÄüéäüéâüéà‚ú®üí´‚≠êüåüüí•üî•‚ù§üß°üíõüíöüíôüíúüñ§ü§çüíØ'.split(''),
  'üè†': 'üè†üè°üè¢üè•üè¶üè®üè™üè´üè≠üèØüè∞üóºüóΩ‚õ™üïå‚õ©‚õ≤üåÉüåÑüåÖüåÜüåáüåâüé†üé°üé¢'.split(''),
  '‚òÄÔ∏è': '‚òÄüå§‚õÖ‚òÅüåß‚õàüå©üå®‚ùÑ‚òÉ‚õÑüí®üíß‚òîüåäüåàüåôüåõüåúüåöüåùüåûü™êüåçüåëüåïüåå'.split(''),
};
const QUICK = ['üê§','üê∏','‚≠ê','‚ù§Ô∏è','üî•','üíé','üåä','üåø','üéà','üöÄ'];

let board = [], tiles = [];
let selectedColor = 'none', currentCat = 'üòÄ', dragData = null;
let paths = [], isPlaying = false, isRecording = false;
let recordingPath = [], recordingEmoji = '';
let tickSpeed = 1, tickTimer = null;

const $ = id => document.getElementById(id);
const boardEl = $('board'), boardWrap = $('boardWrap');
const colorGridEl = $('colorGrid'), quickEmojiEl = $('quickEmoji');
const catRowEl = $('catRow'), emojiGridEl = $('emojiGrid');
const pathListEl = $('pathList'), speedSlider = $('speedSlider');
const speedVal = $('speedVal'), recordBtn = $('recordBtn'), playBtn = $('playBtn');

const isKing = (r, c) => (c >= 7 && r <= 1) || (c <= 1 && r >= 13);

function init() {
  board = [];
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      if (!isKing(r, c)) board.push({ r, c, color: 'none', emoji: '' });
    }
  }
  renderBoard(); renderColors(); renderQuickEmoji();
  renderCats(); renderEmojis(); renderPaths(); setupEvents();
}

function renderBoard() {
  boardEl.innerHTML = ''; tiles = [];
  const dk = document.createElement('div');
  dk.className = 'tile king duck-king'; dk.textContent = 'üê§';
  boardEl.appendChild(dk);
  const fk = document.createElement('div');
  fk.className = 'tile king frog-king'; fk.textContent = 'üê∏';
  boardEl.appendChild(fk);
  board.forEach((t, i) => {
    const el = document.createElement('div');
    el.className = 'tile'; el.dataset.idx = i; el.dataset.color = t.color;
    el.style.gridColumn = t.c + 1; el.style.gridRow = t.r + 1;
    if (t.emoji) { el.textContent = t.emoji; el.draggable = true; }
    tiles[i] = el; boardEl.appendChild(el);
  });
}

function updateTile(i) {
  const t = board[i], el = tiles[i];
  if (!el) return;
  el.dataset.color = t.color;
  el.textContent = t.emoji || '';
  el.draggable = !!t.emoji;
}

function renderColors() {
  colorGridEl.innerHTML = '';
  COLORS.forEach(c => {
    const btn = document.createElement('div');
    btn.className = 'color-btn' + (c === selectedColor ? ' selected' : '');
    btn.dataset.c = c; btn.draggable = true;
    colorGridEl.appendChild(btn);
  });
}

function renderQuickEmoji() {
  quickEmojiEl.innerHTML = '';
  QUICK.forEach(e => {
    const btn = document.createElement('div');
    btn.className = 'emoji-btn'; btn.textContent = e;
    btn.draggable = true; btn.dataset.emoji = e;
    quickEmojiEl.appendChild(btn);
  });
}

function renderCats() {
  catRowEl.innerHTML = '';
  Object.keys(EMOJIS).forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'cat-btn' + (cat === currentCat ? ' active' : '');
    btn.textContent = cat; btn.dataset.cat = cat;
    catRowEl.appendChild(btn);
  });
}

function renderEmojis() {
  emojiGridEl.innerHTML = '';
  (EMOJIS[currentCat] || []).forEach(e => {
    const btn = document.createElement('div');
    btn.className = 'emoji-btn'; btn.textContent = e;
    btn.draggable = true; btn.dataset.emoji = e;
    emojiGridEl.appendChild(btn);
  });
}

function renderPaths() {
  pathListEl.innerHTML = '';
  if (paths.length === 0) {
    pathListEl.innerHTML = '<div class="no-paths">–ù–µ–º–∞—î –º–∞—Ä—à—Ä—É—Ç—ñ–≤</div>';
    return;
  }
  paths.forEach((p, i) => {
    const div = document.createElement('div');
    div.className = 'path-item'; div.dataset.pathIdx = i;
    div.innerHTML = `<span class="path-emoji">${p.emoji}</span>
      <span class="path-info">${p.tiles.length} —Ç–æ—á–æ–∫</span>
      <button class="path-del" data-del="${i}">√ó</button>`;
    pathListEl.appendChild(div);
  });
}

function clearPathHighlights() {
  tiles.forEach(t => t && t.classList.remove('path-point'));
}

function setupEvents() {
  colorGridEl.onclick = e => {
    const btn = e.target.closest('.color-btn');
    if (btn) { selectedColor = btn.dataset.c; renderColors(); }
  };
  catRowEl.onclick = e => {
    const btn = e.target.closest('.cat-btn');
    if (btn) { currentCat = btn.dataset.cat; renderCats(); renderEmojis(); }
  };
  pathListEl.onclick = e => {
    const del = e.target.closest('.path-del');
    if (del) { paths.splice(parseInt(del.dataset.del), 1); renderPaths(); }
  };

  document.addEventListener('dragstart', e => {
    const t = e.target;
    if (t.classList.contains('color-btn')) dragData = { type: 'color', value: t.dataset.c };
    else if (t.dataset.emoji) dragData = { type: 'emoji', value: t.dataset.emoji };
    else if (t.classList.contains('tile') && !t.classList.contains('king') && t.textContent) {
      dragData = { type: 'tile', value: t.textContent, from: parseInt(t.dataset.idx) };
      t.classList.add('dragging');
    }
    if (dragData) e.dataTransfer.setData('text', '');
  });
  document.addEventListener('dragend', () => {
    dragData = null;
    document.querySelectorAll('.dragging,.drag-over').forEach(el => el.classList.remove('dragging','drag-over'));
  });
  document.addEventListener('dragover', e => {
    if (!dragData) return;
    const tile = e.target.closest('.tile:not(.king)');
    if (tile) { e.preventDefault(); tile.classList.add('drag-over'); }
  });
  document.addEventListener('dragleave', e => {
    const tile = e.target.closest('.tile');
    if (tile) tile.classList.remove('drag-over');
  });
  document.addEventListener('drop', e => {
    if (!dragData) return;
    e.preventDefault();
    const tile = e.target.closest('.tile:not(.king)');
    if (tile) {
      const i = parseInt(tile.dataset.idx);
      if (dragData.type === 'color') board[i].color = dragData.value;
      else if (dragData.type === 'emoji') board[i].emoji = dragData.value;
      else if (dragData.type === 'tile' && dragData.from !== i) {
        board[i].emoji = dragData.value;
        board[dragData.from].emoji = '';
        updateTile(dragData.from);
      }
      updateTile(i);
    }
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    dragData = null;
  });

  boardEl.onclick = e => {
    const tile = e.target.closest('.tile:not(.king)');
    if (!tile) return;
    const i = parseInt(tile.dataset.idx);
    if (isRecording) {
      if (!recordingEmoji && board[i].emoji) {
        recordingEmoji = board[i].emoji;
        recordingPath = [i];
        tile.classList.add('path-point');
      } else if (recordingEmoji && !recordingPath.includes(i)) {
        recordingPath.push(i);
        tile.classList.add('path-point');
      }
    } else {
      board[i].color = selectedColor;
      updateTile(i);
    }
  };
  boardEl.ondblclick = e => {
    if (isRecording) return;
    const tile = e.target.closest('.tile:not(.king)');
    if (!tile) return;
    board[parseInt(tile.dataset.idx)].emoji = '';
    updateTile(parseInt(tile.dataset.idx));
  };
  boardEl.oncontextmenu = e => {
    const tile = e.target.closest('.tile:not(.king)');
    if (!tile) return;
    e.preventDefault();
    const i = parseInt(tile.dataset.idx);
    board[i].emoji = ''; board[i].color = 'none';
    updateTile(i);
  };

  speedSlider.oninput = () => {
    tickSpeed = parseFloat(speedSlider.value);
    speedVal.textContent = tickSpeed + '√ó';
    if (isPlaying) restartTicker();
  };

  recordBtn.onclick = toggleRecord;
  playBtn.onclick = togglePlay;
  $('clearPathsBtn').onclick = clearPaths;
  $('saveBtn').onclick = saveAll;
  $('loadBtn').onclick = loadAll;
  $('resetBtn').onclick = resetBoard;
}

function toggleRecord() {
  if (isRecording) {
    isRecording = false;
    recordBtn.classList.remove('recording');
    recordBtn.textContent = 'üî¥ –ó–∞–ø–∏—Å–∞—Ç–∏';
    boardWrap.classList.remove('recording');
    if (recordingPath.length >= 2 && recordingEmoji) {
      paths.push({ emoji: recordingEmoji, tiles: [...recordingPath], step: 0 });
      renderPaths();
    }
    clearPathHighlights();
    recordingPath = []; recordingEmoji = '';
  } else {
    if (isPlaying) togglePlay();
    isRecording = true; recordingPath = []; recordingEmoji = '';
    recordBtn.classList.add('recording');
    recordBtn.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
    boardWrap.classList.add('recording');
  }
}

function togglePlay() {
  if (isPlaying) {
    stopTicker(); isPlaying = false;
    playBtn.textContent = '‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç';
    playBtn.classList.remove('active');
  } else {
    if (paths.length === 0) return alert('–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏!');
    if (isRecording) toggleRecord();
    isPlaying = true;
    playBtn.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
    playBtn.classList.add('active');
    startTicker();
  }
}

function startTicker() { stopTicker(); tickTimer = setInterval(tick, 1000 / tickSpeed); }
function stopTicker() { if (tickTimer) { clearInterval(tickTimer); tickTimer = null; } }
function restartTicker() { if (isPlaying) startTicker(); }

function tick() {
  paths.forEach(p => {
    if (p.tiles.length < 2) return;
    const from = p.tiles[p.step];
    const next = (p.step + 1) % p.tiles.length;
    const to = p.tiles[next];
    board[from].emoji = ''; board[to].emoji = p.emoji;
    updateTile(from); updateTile(to);
    p.step = next;
  });
}

function clearPaths() {
  if (isPlaying) togglePlay();
  paths = []; renderPaths();
}

function saveAll() {
  localStorage.setItem('tile-v5', JSON.stringify({ board, paths }));
  alert('üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–æ!');
}

function loadAll() {
  try {
    const d = JSON.parse(localStorage.getItem('tile-v5'));
    if (d) {
      if (isPlaying) togglePlay();
      board = d.board || board; paths = d.paths || [];
      renderBoard(); renderPaths();
      alert('üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!');
    } else alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö');
  } catch(e) { alert('–ü–æ–º–∏–ª–∫–∞'); }
}

function resetBoard() {
  if (confirm('–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ?')) {
    if (isPlaying) togglePlay();
    if (isRecording) toggleRecord();
    paths = []; init();
  }
}

init();
window.onbeforeunload = () => stopTicker();
document.onvisibilitychange = () => { if (document.hidden && isPlaying) togglePlay(); };
</script>
</body>
</html>
